<!DOCTYPE html>
<!-- TODO: en-tête à ajouter -->
<html>
<head>
    <meta charset="utf-8"/>
    <title>Baremaps CollectIpLoc</title>
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no"/>
    <style>
        form {
            margin-bottom: 1rem;
        }

        td, th {
            padding: 1rem;
            border: 1px solid black;
        }

        table {
            border-collapse: collapse;
        }
    </style>
</head>
<body>
<!-- A welcome message and explanation of the project -->
<div style="padding-bottom: 3rem">
        <span style="display: block; padding-bottom: 1rem; font-size: 2rem">
            May you help us ?
        </span>
    <span>
            Our goal is to test our API, Baremaps Iploc. For this, we need to compare the results of the localisation by our API and the one your browser knows. If you agree to share us your location, you will be really helpful in our research.
        </span>
</div>
<div id="infosType" style="padding-bottom: 3rem">
    <span style="display: block; padding-bottom: 0.5rem; font-size: 1.5rem">
        What type of information ?
    </span>
    <span>
        The informations you will share us if you agree are : longitude, latitude, altitude, accuracy (of longitude/latitude), altitude accuracy, heading (direction towards which the device is facing), speed, ip and MAC addresses, the time at which the share is done and the mode of acquisition (Web, App, ...).
    </span>
</div>

<!-- Ask to share the location -->
<div id="askLocation" style="padding-bottom: 1rem">
        <span style="display: block; padding-bottom: 0.5rem; font-size: 1.5rem">
            Don't you mind to share us these informations ?
        </span>
    <span>
            Your browser will ask you with a pop-up if you want to block or authorize our website to know your location. If you agree, choose "Authorize" please.
        </span>
</div>
<!-- Button to accept to share the location -->
<button onclick="getLocation()" id="shareButton" style="padding: 0.3rem 0.6rem">
    <label style="font-size: 1.2rem">
        Share my location
    </label>
</button>

<!-- The table of retrieved GeoLocation informations -->
<p id="info" style="padding-top: 1rem; text-decoration: underline"></p>
<table id="properties" style="margin-bottom: 3rem"></table>

<!-- Thanks to the user -->
<p id="thanks" style="margin: 0"></p>

<!-- Recuperation of GeoLocation properties (and ip address) -->
<script>
    var propertiesTableFilled = false,
        dataSent = false;

    function getLocation() {
        if (navigator.geolocation && !dataSent) {
            var info = document.getElementById('info'),
                properties = document.getElementById('properties'),
                thanks = document.getElementById('thanks');

            // GeoLocation properties recuperation, avoiding having some of them with value "null"
            navigator.geolocation.getCurrentPosition(function (position) {
                var longitude = position.coords.longitude,
                    latitude = position.coords.latitude,
                    altitude = position.coords.altitude ?? 0.0,
                    accuracy = position.coords.accuracy,
                    altitudeAccuracy = position.coords.altitudeAccuracy ?? 0.0,
                    heading = position.coords.heading ?? 0.0,
                    speed = position.coords.speed ?? 0.0;

                // GeoLocation properties and ip address recuperation with request to API CollectIpLoc
                const request = new XMLHttpRequest();
                request.open('POST', `http://localhost:8080/location`, true);
                request.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');

                const params = `longitude=${longitude}&latitude=${latitude}&altitude=${altitude}&accuracy=${accuracy}&altitudeAccuracy=${altitudeAccuracy}&heading=${heading}&speed=${speed}`;

                request.onreadystatechange = function() {
                    if (request.readyState === XMLHttpRequest.DONE) {
                        if (request.status === 200)
                            console.log('POST request successful!');
                        else
                            console.log('POST request failed!');
                    }
                };

                request.send(params);
                dataSent = true;

                if (!propertiesTableFilled) {
                    // Table's title
                    info.innerHTML = 'The informations you shared us (0 may mean unavailable)';

                    let pos = 0;
                    const headers = ["Longitude", "Latitude", "Altitude", "Accuracy", "AltitudeAccuracy", "Heading", "Speed"],
                        dataValues = [longitude, latitude, altitude, accuracy, altitudeAccuracy, heading, speed];

                    // TODO: peut-être au lieu d'utiliser une table, simplement une div, et utiliser un affichage vertical que ce soit mobile ou Web, plus simple
                    // Insert GeoLocation informations in the table
                    if (window.matchMedia("(min-width: 800px)").matches) { // Width screen >= 800px
                        // Insert header row
                        const headersRow = properties.insertRow(0);
                        headers.forEach(header => {
                            let cell = headersRow.insertCell(pos++);
                            cell.innerHTML = `<strong>${header}</strong>`;
                        })

                        // Insert GeoLocation properties values
                        const dataRow = properties.insertRow(1);
                        pos = 0;
                        dataValues.forEach(data => {
                            let cell = dataRow.insertCell(pos++);
                            cell.innerHTML = data.toString();
                        })
                    } else if (window.matchMedia("(min-width: 320px)").matches) { // Width screen >= 320px
                        // Insert header column
                        headers.forEach(header => {
                            let headersRow = properties.insertRow(pos++);
                            headersRow.innerHTML = `<th>${header}</th>`;
                        })

                        // Insert GeoLocation properties values
                        pos = 0;
                        dataValues.forEach(data => {
                            properties.rows[pos++].insertCell().innerHTML = data.toString();
                        })
                    } else { // Width screen < 320px
                        // TODO : format pour Galaxy Fold, peut-être header/data/header/data/... verticalement
                    }

                    var askLocation = document.getElementById('askLocation'),
                        infosType = document.getElementById('infosType'),
                        shareButton = document.getElementById('shareButton');

                    // shareButton deactivation
                    shareButton.disabled = true;
                    askLocation.style.display = infosType.style.display = shareButton.style.display = 'none';
                    // Display correction
                    info.style.paddingTop = '0';
                    info.style.margin = '0 0 1rem';

                    propertiesTableFilled = true;
                }

                thanks.innerHTML = 'Thank you!';
            });
        } else
            console.log('Geolocation is not available.');
    }
</script>
<style>
    body {
        font-family: Arial, serif;
        text-align: center;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        min-height: 100vh;
        margin: 2rem;
    }

    button:hover {
        background-color: #33b249;
    }
</style>
</body>
</html>